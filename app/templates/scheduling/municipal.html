{% extends "base.html" %}
{% block title %}Agendamento Municipal{% endblock %}

{% block content %}
<h1 class="text-2xl font-semibold text-slate-700 mb-6">Agendamento Municipal</h1>

<!-- Filtros: ano / mÃªs / prioridade -->
<div class="bg-white rounded-lg shadow p-4 md:p-6 mb-4">
  <form method="get" action="{{ url_for('scheduling.lista', tipo=tipo) }}" class="grid grid-cols-1 md:grid-cols-4 gap-3 items-end">
    <div>
      <label class="text-xs font-medium text-slate-600 block mb-1">Ano</label>
      <select name="ano" class="w-full rounded border-slate-300 text-sm">
        <option value="">Todos</option>
        {% for a in anos_disponiveis %}
          <option value="{{ a }}" {% if ano_selecionado == a %}selected{% endif %}>{{ a }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label class="text-xs font-medium text-slate-600 block mb-1">MÃªs</label>
      <select name="mes" class="w-full rounded border-slate-300 text-sm">
        <option value="">Todos</option>
        {% for m_val, m_nome in meses %}
          <option value="{{ m_val }}" {% if mes_selecionado == m_val %}selected{% endif %}>{{ m_nome }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label class="text-xs font-medium text-slate-600 block mb-1">Prioridade</label>
      <select name="prioridade" class="w-full rounded border-slate-300 text-sm">
        <option value="">Todas</option>
        <option value="P1" {% if prioridade_selecionada == 'P1' %}selected{% endif %}>P1</option>
        <option value="P2" {% if prioridade_selecionada == 'P2' %}selected{% endif %}>P2</option>
      </select>
    </div>
    <div>
      <label class="text-xs font-medium text-slate-600 block mb-1">CPF</label>
      <input type="text" name="cpf" maxlength="11" value="{{ cpf_selecionado or '' }}" class="w-full rounded border-slate-300 text-sm" placeholder="Apenas nÃºmeros">
    </div>

    <div>
      <label class="text-xs font-medium text-slate-600 block mb-1">Nome</label>
      <input type="text" name="nome" value="{{ nome_selecionado or '' }}" class="w-full rounded border-slate-300 text-sm" placeholder="Nome do paciente">
    </div>

    <div class="flex gap-2">
      <button type="submit" class="btn-primary">Buscar</button>
      <a href="{{ url_for('scheduling.lista', tipo=tipo) }}" class="inline-flex items-center px-3 py-2 rounded border border-slate-200 text-sm text-slate-600">Limpar</a>
    </div>
  </form>
</div>

<!-- Filtros ativos -->
{% if ano_selecionado or mes_selecionado or prioridade_selecionada or nome_selecionado or cpf_selecionado %}
  <div class="mt-3 p-3 bg-blue-50 rounded-lg">
    <p class="text-sm text-blue-800 mb-2">Filtros ativos:</p>
    <div class="flex flex-wrap gap-2">
      {% if ano_selecionado %}
        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
          Ano: {{ ano_selecionado }}
          <a href="{{ url_for('scheduling.lista', tipo=tipo, mes=mes_selecionado or '', prioridade=prioridade_selecionada or '', nome=nome_selecionado or '', cpf=cpf_selecionado or '') }}" class="ml-1 text-blue-600 hover:text-blue-800">Ã—</a>
        </span>
      {% endif %}
      {% if mes_selecionado %}
        {# Resolve nome do mÃªs a partir da lista `meses` #}
        {% set mes_nome = '' %}
        {% for m_val, m_nome in meses %}
          {% if m_val == mes_selecionado %}
            {% set mes_nome = m_nome %}
          {% endif %}
        {% endfor %}
        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
          MÃªs: {{ mes_nome }}
          <a href="{{ url_for('scheduling.lista', tipo=tipo, ano=ano_selecionado or '', prioridade=prioridade_selecionada or '', nome=nome_selecionado or '', cpf=cpf_selecionado or '') }}" class="ml-1 text-blue-600 hover:text-blue-800">Ã—</a>
        </span>
      {% endif %}
      {% if prioridade_selecionada %}
        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
          Prioridade: {{ prioridade_selecionada }}
          <a href="{{ url_for('scheduling.lista', tipo=tipo, ano=ano_selecionado or '', mes=mes_selecionado or '', nome=nome_selecionado or '', cpf=cpf_selecionado or '') }}" class="ml-1 text-blue-600 hover:text-blue-800">Ã—</a>
        </span>
      {% endif %}
      {% if nome_selecionado %}
        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
          Nome: {{ nome_selecionado }}
          <a href="{{ url_for('scheduling.lista', tipo=tipo, ano=ano_selecionado or '', mes=mes_selecionado or '', prioridade=prioridade_selecionada or '', cpf=cpf_selecionado or '') }}" class="ml-1 text-blue-600 hover:text-blue-800">Ã—</a>
        </span>
      {% endif %}
      {% if cpf_selecionado %}
        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
          CPF: {{ cpf_selecionado }}
          <a href="{{ url_for('scheduling.lista', tipo=tipo, ano=ano_selecionado or '', mes=mes_selecionado or '', prioridade=prioridade_selecionada or '', nome=nome_selecionado or '') }}" class="ml-1 text-blue-600 hover:text-blue-800">Ã—</a>
        </span>
      {% endif %}
    </div>
  </div>
{% endif %}

<!-- Abas -->
<div class="border-b border-gray-200 mb-4">
  <ul class="flex flex-wrap -mb-px text-sm font-medium text-center">

    {% if tipo_agendador == 'exame' or (role == 'admin') or not tipo_agendador %}
    <li class="me-2">
      <button
        class="inline-block p-4 border-b-2 rounded-t-lg active-tab"
        id="tab-exames"
        data-tab-target="exames">
        Exames
      </button>
    </li>
    {% endif %}

    {% if tipo_agendador == 'consulta' or (role == 'admin') or not tipo_agendador %}
    <li class="me-2">
      <button
        class="inline-block p-4 border-b-2 rounded-t-lg text-gray-500 hover:text-gray-600 {% if tipo_agendador == 'consulta' %}active-tab{% endif %}"
        id="tab-consultas"
        data-tab-target="consultas">
        Consultas
      </button>
    </li>
    {% endif %}

    {% if not tipo_agendador or tipo_agendador == 'exame' %}
    <li class="me-2">
      <button
        class="inline-block p-4 border-b-2 rounded-t-lg text-gray-500 hover:text-gray-600"
        id="tab-tabela"
        data-tab-target="tabela">
        Tabela
      </button>
    </li>
    {% endif %}

  </ul>
</div>

<!-- ConteÃºdo -->
<div id="tab-content">

  <!-- EXAMES -->
  {% if tipo_agendador == 'exame' or (role == 'admin') or not tipo_agendador %}
    <div id="tab-exames-content" class="tab-pane {% if request.args.get('tab') == 'consultas' %}hidden{% else %}block{% endif %}">
        {% set pedidos = exames %}  <!-- âœ… Sempre usar lista 'exames' na aba exames -->
        {% include "scheduling/partials/lista.html" with context %}
    </div>
  {% endif %}

  <!-- CONSULTAS -->
  {% if tipo_agendador == 'consulta' or (role == 'admin') or not tipo_agendador %}
    <div id="tab-consultas-content" class="tab-pane {% if request.args.get('tab') == 'consultas' %}block{% else %}hidden{% endif %}">
      {% set pedidos = consultas %}  <!-- âœ… Sempre usar lista 'consultas' na aba consultas -->
      {% include "scheduling/partials/lista_consultas.html" with context %}
    </div>
  {% endif %}

  <!-- TABELA -->
  {% if not tipo_agendador or tipo_agendador == 'exame' %}
  <div id="tab-tabela-content" class="tab-pane hidden p-4">
    <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-x-auto">
      {% if dados %}
        <div class="overflow-x-auto">
          <table class="min-w-full w-full bg-white rounded-lg shadow-sm border border-slate-200" style="border-collapse: collapse;">
            <thead class="bg-slate-50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Tipo de Exame</th>
                {% for mes in meses_ordenados %}
                  {%- set _parts = mes.split('/') if '/' in mes else [] -%}
                  <th class="px-4 py-3 text-center text-xs font-semibold text-slate-500 uppercase tabela-month-header cursor-pointer" {% if _parts %}data-month="{{ _parts[0]|int }}" data-year="{{ _parts[1]|int }}"{% endif %}>{{ mes }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-slate-200">
                {% for exame, meses_dict in dados.items() %}
                <tr>
                  <td class="px-4 py-3 font-medium text-primario-600 tabela-exame cursor-pointer" data-exame="{{ exame|e }}">{{ exame }}</td>
                  {% for mes in meses_ordenados %}
                    {% set info = meses_dict.get(mes, {'P1':0, 'P2':0}) %}
                    {%- set _parts = mes.split('/') if '/' in mes else [] -%}
                    <td data-mes="{{ mes }}" {% if _parts %}data-month="{{ _parts[0]|int }}" data-year="{{ _parts[1]|int }}"{% endif %} class="px-4 py-3 text-center align-middle cursor-pointer tabela-celula">
                      <div class="flex items-center justify-center gap-2">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800">P1: {{ info.P1 }}</span>
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-amber-100 text-amber-800">P2: {{ info.P2 }}</span>
                      </div>
                    </td>
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

      {% elif exames %}
        {# Se 'dados' nÃ£o foi provido pelo backend, construir a tabela a partir de 'exames' #}
        {% macro month_year(p) %}
          {%- if p.data_solicitacao is string -%}
            {%- set parts = p.data_solicitacao.split('-') -%}
            {%- if parts|length >= 2 -%}{{ "%02d"|format(parts[1]|int) }}/{{ parts[0] }}{%- else -%}{{ p.data_solicitacao }}{%- endif -%}
          {%- else -%}
            {{ p.data_solicitacao.strftime('%m/%Y') if p.data_solicitacao else '' }}
          {%- endif -%}
        {% endmacro %}

        {% set exames_nomes = [] %}
        {% for p in exames %}
          {% set nome_exame = (p.exame_nome or p.nome_solicitacao) %}
          {% if nome_exame and nome_exame not in exames_nomes %}
            {% set _ = exames_nomes.append(nome_exame) %}
          {% endif %}
        {% endfor %}

        <div class="overflow-x-auto">
          <table class="min-w-full w-full bg-white rounded-lg shadow-sm border border-slate-200" style="border-collapse: collapse;">
            <thead class="bg-slate-50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Tipo de Exame</th>
                {% for mes in meses_ordenados %}
                  {%- set _parts = mes.split('/') if '/' in mes else [] -%}
                  <th class="px-4 py-3 text-center text-xs font-semibold text-slate-500 uppercase tabela-month-header cursor-pointer" {% if _parts %}data-month="{{ _parts[0]|int }}" data-year="{{ _parts[1]|int }}"{% endif %}>{{ mes }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-slate-200">
              {% for exame_nome in exames_nomes %}
                <tr>
                  <td class="px-4 py-3 font-medium text-primario-600 tabela-exame cursor-pointer" data-exame="{{ exame_nome|e }}">{{ exame_nome }}</td>
                  {% for mes in meses_ordenados %}
                    {%- set p1 = 0 -%}
                    {%- set p2 = 0 -%}
                    {% for p in exames %}
                      {% set nome_ex = (p.exame_nome or p.nome_solicitacao) %}
                      {% if nome_ex == exame_nome and month_year(p) == mes %}
                        {% if p.prioridade == 'P1' %}
                          {% set p1 = p1 + 1 %}
                        {% elif p.prioridade == 'P2' %}
                          {% set p2 = p2 + 1 %}
                        {% endif %}
                      {% endif %}
                    {% endfor %}
                    {%- set _parts = mes.split('/') if '/' in mes else [] -%}
                    <td data-mes="{{ mes }}" {% if _parts %}data-month="{{ _parts[0]|int }}" data-year="{{ _parts[1]|int }}"{% endif %} class="px-4 py-3 text-center align-middle cursor-pointer tabela-celula">
                      <div class="flex items-center justify-center gap-2">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800">P1: {{ p1 }}</span>
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-amber-100 text-amber-800">P2: {{ p2 }}</span>
                      </div>
                    </td>
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

      {% else %}
        <div style="text-align:center; padding:40px; color:#999;">
          <p style="font-size:2em; margin:0;">ðŸ“­</p>
          <p style="margin:10px 0 0 0; font-size:1.1em;">Nenhum pedido encontrado</p>
          <p style="margin:5px 0 0 0; color:#ccc; font-size:0.9em;">Todos os pedidos com tentativas de contato iniciadas aparecerÃ£o aqui</p>
        </div>
      {% endif %}
    </div>
  </div>

</div>

<!-- Abas script -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const tabs = document.querySelectorAll("[data-tab-target]");
  const panes = document.querySelectorAll(".tab-pane");

  tabs.forEach(tab => {
    tab.addEventListener("click", () => {

      // reset
      tabs.forEach(t => t.classList.remove("active-tab", "border-blue-500", "text-blue-600"));
      panes.forEach(p => p.classList.add("hidden"));

      // ativa
      tab.classList.add("active-tab", "border-blue-500", "text-blue-600");
      document.getElementById(`tab-${tab.dataset.tabTarget}-content`).classList.remove("hidden");
    });
  });

  // tabela exibida sem comportamento clicÃ¡vel
});
</script>

<script>
// Clique em cÃ©lula da tabela -> redireciona para a aba Exames com filtros mes/ano
document.addEventListener('DOMContentLoaded', () => {
  const baseUrl = "{{ url_for('scheduling.lista', tipo=tipo) }}";
  document.querySelectorAll('.tabela-celula').forEach(td => {
    td.addEventListener('click', () => {
      const month = td.dataset.month;
      const year = td.dataset.year;
      if (month && year) {
        // direciona para a rota com query params (irÃ¡ abrir a pÃ¡gina com aba Exames por padrÃ£o)
        const url = `${baseUrl}?mes=${encodeURIComponent(month)}&ano=${encodeURIComponent(year)}`;
        window.location.href = url;
      }
    });
    td.addEventListener('mouseenter', () => td.classList.add('hover:brightness-95'));
    td.style.cursor = 'pointer';
  });
  // clique no nome do exame -> filtrar por exame
  document.querySelectorAll('.tabela-exame').forEach(td => {
    td.addEventListener('click', () => {
      const exame = td.dataset.exame;
      if (exame) {
        const url = `${baseUrl}?exame=${encodeURIComponent(exame)}`;
        window.location.href = url;
      }
    });
    td.style.cursor = 'pointer';
  });

  // clique no cabeÃ§alho do mÃªs -> filtrar por mÃªs/ano (torna a coluna inteira filtrÃ¡vel a partir do header)
  document.querySelectorAll('.tabela-month-header').forEach(th => {
    th.addEventListener('click', () => {
      const month = th.dataset.month;
      const year = th.dataset.year;
      if (month && year) {
        const url = `${baseUrl}?mes=${encodeURIComponent(month)}&ano=${encodeURIComponent(year)}`;
        window.location.href = url;
      }
    });
    th.style.cursor = 'pointer';
  });
});
</script>

<style>
  .active-tab {
    color: #2563eb;
    border-color: #2563eb;
  }
</style>
  </div>
  {% endif %}

{% endblock %}


