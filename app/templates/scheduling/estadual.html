{% extends "base.html" %}
{% block title %}Agendamento Cross / Estadual{% endblock %}

{% block content %}
<h1 class="text-2xl font-semibold text-slate-700 mb-6">Agendamento Cross / Estadual</h1>

<!-- Filtros: ano / mês / prioridade -->
<div class="bg-white rounded-lg shadow p-4 md:p-6 mb-4">
	<form method="get" action="{{ url_for('scheduling.lista', tipo=tipo) }}" class="grid grid-cols-1 md:grid-cols-4 gap-3 items-end">
		<div>
			<label class="text-xs font-medium text-slate-600 block mb-1">Ano</label>
			<select name="ano" class="w-full rounded border-slate-300 text-sm">
				<option value="">Todos</option>
				{% for a in anos_disponiveis %}
					<option value="{{ a }}" {% if ano_selecionado == a %}selected{% endif %}>{{ a }}</option>
				{% endfor %}
			</select>
		</div>

		<div>
			<label class="text-xs font-medium text-slate-600 block mb-1">Mês</label>
			<select name="mes" class="w-full rounded border-slate-300 text-sm">
				<option value="">Todos</option>
				{% for m_val, m_nome in meses %}
					<option value="{{ m_val }}" {% if mes_selecionado == m_val %}selected{% endif %}>{{ m_nome }}</option>
				{% endfor %}
			</select>
		</div>

		<div>
			<label class="text-xs font-medium text-slate-600 block mb-1">Prioridade</label>
			<select name="prioridade" class="w-full rounded border-slate-300 text-sm">
				<option value="">Todas</option>
				<option value="P1" {% if prioridade_selecionada == 'P1' %}selected{% endif %}>P1</option>
				<option value="P2" {% if prioridade_selecionada == 'P2' %}selected{% endif %}>P2</option>
			</select>
		</div>
		<div>
			<label class="text-xs font-medium text-slate-600 block mb-1">CPF</label>
			<input type="text" name="cpf" maxlength="11" value="{{ cpf_selecionado or '' }}" class="w-full rounded border-slate-300 text-sm" placeholder="Apenas números">
		</div>

		<div>
			<label class="text-xs font-medium text-slate-600 block mb-1">Nome</label>
			<input type="text" name="nome" value="{{ nome_selecionado or '' }}" class="w-full rounded border-slate-300 text-sm" placeholder="Nome do paciente">
		</div>

		<div class="flex gap-2">
			<button type="submit" class="btn-primary">Buscar</button>
			<a href="{{ url_for('scheduling.lista', tipo=tipo) }}" class="inline-flex items-center px-3 py-2 rounded border border-slate-200 text-sm text-slate-600">Limpar</a>
		</div>
	</form>
</div>

<!-- Filtros ativos -->
{% if ano_selecionado or mes_selecionado or prioridade_selecionada or nome_selecionado or cpf_selecionado %}
	<div class="mt-3 p-3 bg-blue-50 rounded-lg">
		<p class="text-sm text-blue-800 mb-2">Filtros ativos:</p>
		<div class="flex flex-wrap gap-2">
			{% if ano_selecionado %}
				<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
					Ano: {{ ano_selecionado }}
					<a href="{{ url_for('scheduling.lista', tipo=tipo, mes=mes_selecionado or '', prioridade=prioridade_selecionada or '', nome=nome_selecionado or '', cpf=cpf_selecionado or '') }}" class="ml-1 text-blue-600 hover:text-blue-800">×</a>
				</span>
			{% endif %}
			{% if mes_selecionado %}
				{# Resolve nome do mês a partir da lista `meses` #}
				{% set mes_nome = '' %}
				{% for m_val, m_nome in meses %}
					{% if m_val == mes_selecionado %}
						{% set mes_nome = m_nome %}
					{% endif %}
				{% endfor %}
				<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
					Mês: {{ mes_nome }}
					<a href="{{ url_for('scheduling.lista', tipo=tipo, ano=ano_selecionado or '', prioridade=prioridade_selecionada or '', nome=nome_selecionado or '', cpf=cpf_selecionado or '') }}" class="ml-1 text-blue-600 hover:text-blue-800">×</a>
				</span>
			{% endif %}
			{% if prioridade_selecionada %}
				<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
					Prioridade: {{ prioridade_selecionada }}
					<a href="{{ url_for('scheduling.lista', tipo=tipo, ano=ano_selecionado or '', mes=mes_selecionado or '', nome=nome_selecionado or '', cpf=cpf_selecionado or '') }}" class="ml-1 text-blue-600 hover:text-blue-800">×</a>
				</span>
			{% endif %}
			{% if nome_selecionado %}
				<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
					Nome: {{ nome_selecionado }}
					<a href="{{ url_for('scheduling.lista', tipo=tipo, ano=ano_selecionado or '', mes=mes_selecionado or '', prioridade=prioridade_selecionada or '', cpf=cpf_selecionado or '') }}" class="ml-1 text-blue-600 hover:text-blue-800">×</a>
				</span>
			{% endif %}
			{% if cpf_selecionado %}
				<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
					CPF: {{ cpf_selecionado }}
					<a href="{{ url_for('scheduling.lista', tipo=tipo, ano=ano_selecionado or '', mes=mes_selecionado or '', prioridade=prioridade_selecionada or '', nome=nome_selecionado or '') }}" class="ml-1 text-blue-600 hover:text-blue-800">×</a>
				</span>
			{% endif %}
		</div>
	</div>
{% endif %}

<!-- Abas -->
<div class="border-b border-gray-200 mb-4">
	<ul class="flex flex-wrap -mb-px text-sm font-medium text-center">

		<li class="me-2">
			<button
				class="inline-block p-4 border-b-2 rounded-t-lg active-tab"
				id="tab-exames"
				data-tab-target="exames">
				Exames
			</button>
		</li>

		<li class="me-2">
			<button
				class="inline-block p-4 border-b-2 rounded-t-lg text-gray-500 hover:text-gray-600"
				id="tab-consultas"
				data-tab-target="consultas">
				Consultas
			</button>
		</li>

	</ul>
</div>

<!-- Conteúdo -->
<div id="tab-content">

	<!-- EXAMES -->
	<div id="tab-exames-content" class="tab-pane block">
		{% set pedidos = exames %}  <!-- ✅ Forçar uso da lista exames -->
		{% include "scheduling/partials/lista.html" with context %}
	</div>

	<!-- CONSULTAS -->
	<div id="tab-consultas-content" class="tab-pane hidden">
		{% set pedidos = consultas %}  <!-- ✅ Forçar uso da lista consultas -->
		{% include "scheduling/partials/lista_consultas.html" with context %}
	</div>

</div>

<!-- Abas script -->
<script>
document.addEventListener("DOMContentLoaded", () => {
	const tabs = document.querySelectorAll("[data-tab-target]");
	const panes = document.querySelectorAll(".tab-pane");

	tabs.forEach(tab => {
		tab.addEventListener("click", () => {

			// reset
			tabs.forEach(t => t.classList.remove("active-tab", "border-blue-500", "text-blue-600"));
			panes.forEach(p => p.classList.add("hidden"));

			// ativa
			tab.classList.add("active-tab", "border-blue-500", "text-blue-600");
			document.getElementById(`tab-${tab.dataset.tabTarget}-content`).classList.remove("hidden");
		});
	});
});
</script>

<style>
	.active-tab {
		color: #2563eb;
		border-color: #2563eb;
	}
</style>

{% endblock %}